{"version":3,"sources":["../../../../src/app/%28dashboard%29/dashboard/DashboardClient.tsx/__nextjs-internal-proxy.mjs","../../../../src/app/%28dashboard%29/dashboard/page.tsx"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const DashboardClient = registerClientReference(\n    function() { throw new Error(\"Attempted to call DashboardClient() from the server but DashboardClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/app/(dashboard)/dashboard/DashboardClient.tsx\",\n    \"DashboardClient\",\n);\n","import { getServerSession } from \"next-auth\";\nimport { authOptions } from \"@/lib/auth\";\nimport { redirect } from \"next/navigation\";\nimport { prisma } from \"@/lib/prisma\";\nimport { DashboardClient } from \"./DashboardClient\";\n\nasync function getDashboardData(dateStr?: string) {\n    let today: Date;\n    if (dateStr) {\n        // Parse \"YYYY-MM-DD\" in local time to avoid UTC shifting\n        const [year, month, day] = dateStr.split('-').map(Number);\n        today = new Date(year, month - 1, day);\n    } else {\n        today = new Date();\n    }\n    today.setHours(0, 0, 0, 0);\n    const tomorrow = new Date(today.getTime() + 24 * 60 * 60 * 1000);\n\n    // Format selectedDate as YYYY-MM-DD in local time\n    const selectedDate = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;\n\n    try {\n        const [\n            activeWorkers,\n            selectedDateAttendance,\n            pendingRequests,\n            lowStockItems,\n            workersByRegion,\n            topStockItems,\n            absentCount,\n            vacationCount,\n            dayOffCount,\n            sickCount,\n        ] = await Promise.all([\n            // Active workers count\n            prisma.worker.count({ where: { status: \"Active\" } }),\n\n            // Attendance for the selected date\n            prisma.attendance.findMany({\n                where: {\n                    date: {\n                        gte: today,\n                        lt: tomorrow,\n                    },\n                },\n                include: {\n                    worker: {\n                        include: { shift: true }\n                    },\n                },\n            }),\n\n            // Pending requests count\n            prisma.request.count({ where: { status: \"Pending\" } }),\n\n            // Low stock items (qty < 10)\n            prisma.inventory.findMany({\n                where: { qty: { lt: 10 } },\n                orderBy: { qty: \"asc\" },\n            }),\n\n            // Workers by region\n            prisma.worker.groupBy({\n                by: [\"region\"],\n                where: { status: \"Active\" },\n                _count: { id: true },\n            }),\n\n            // Top 10 stock items in NSTC\n            prisma.inventory.findMany({\n                where: { location: \"NSTC\" },\n                orderBy: { qty: \"desc\" },\n                take: 10,\n            }),\n\n            // Absent Count\n            prisma.attendance.count({\n                where: {\n                    date: { gte: today, lt: tomorrow },\n                    status: \"Absent\"\n                }\n            }),\n\n            // Vacation Count\n            prisma.attendance.count({\n                where: {\n                    date: { gte: today, lt: tomorrow },\n                    status: \"Vacation\"\n                }\n            }),\n\n            // Day Off Count\n            prisma.attendance.count({\n                where: {\n                    date: { gte: today, lt: tomorrow },\n                    status: \"Day Off\"\n                }\n            }),\n\n            // Sick Leave Count\n            prisma.attendance.count({\n                where: {\n                    date: { gte: today, lt: tomorrow },\n                    status: \"Sick Leave\"\n                }\n            }),\n        ]);\n\n        // Shift specific metrics\n        const a1Attendance = selectedDateAttendance.filter(a => a.worker?.shift?.name === \"A1\");\n        const b1Attendance = selectedDateAttendance.filter(a => a.worker?.shift?.name === \"B1\");\n\n        const a1Present = a1Attendance.filter(a => a.status === \"Present\").length;\n        const b1Present = b1Attendance.filter(a => a.status === \"Present\").length;\n\n        // Get attendance trend (last 7 days from selected date)\n        const trendStart = new Date(today);\n        trendStart.setDate(trendStart.getDate() - 7);\n\n        const recentAttendance = await prisma.attendance.findMany({\n            where: {\n                status: \"Present\",\n                date: { gte: trendStart, lt: tomorrow },\n            },\n            select: { date: true },\n        });\n\n        // Group by date manually\n        const trendMap: Record<string, number> = {};\n        recentAttendance.forEach((a) => {\n            const dateStr = a.date.toISOString().split(\"T\")[0];\n            trendMap[dateStr] = (trendMap[dateStr] || 0) + 1;\n        });\n\n        const attendanceTrend = Object.entries(trendMap)\n            .map(([date, count]) => ({ date, count }))\n            .sort((a, b) => a.date.localeCompare(b.date));\n\n        // Calculate attendance rate\n        const presentCount = selectedDateAttendance.filter((a) => a.status === \"Present\").length;\n        const attendanceRate = activeWorkers > 0\n            ? Math.round((presentCount / activeWorkers) * 100 * 10) / 10\n            : 0;\n\n        return {\n            selectedDate,\n            metrics: {\n                activeWorkers,\n                attendanceRate,\n                presentCount,\n                pendingRequests,\n                lowStockCount: lowStockItems.length,\n                absentCount,\n                vacationCount,\n                dayOffCount,\n                sickCount,\n                a1Present,\n                b1Present,\n                a1Total: a1Attendance.length,\n                b1Total: b1Attendance.length,\n            },\n            lowStockItems: lowStockItems.map((item) => ({\n                nameEn: item.nameEn,\n                qty: item.qty,\n                location: item.location,\n            })),\n            workersByRegion: workersByRegion.map((w) => ({\n                name: w.region || \"Unknown\",\n                value: w._count.id,\n            })),\n            topStockItems: topStockItems.map((item) => ({\n                name: item.nameEn,\n                value: item.qty,\n            })),\n            attendanceTrend,\n            todayAttendance: selectedDateAttendance, // Pass the full detailed list\n        };\n    } catch (error) {\n        console.error(\"Dashboard data error:\", error);\n        return {\n            selectedDate,\n            metrics: {\n                activeWorkers: 0,\n                attendanceRate: 0,\n                presentCount: 0,\n                pendingRequests: 0,\n                lowStockCount: 0,\n                absentCount: 0,\n                vacationCount: 0,\n                dayOffCount: 0,\n                sickCount: 0,\n                a1Present: 0,\n                b1Present: 0,\n                a1Total: 0,\n                b1Total: 0,\n            },\n            lowStockItems: [],\n            workersByRegion: [],\n            topStockItems: [],\n            attendanceTrend: [],\n            todayAttendance: [],\n        };\n    }\n}\n\nexport default async function DashboardPage(props: { searchParams: Promise<{ date?: string }> }) {\n    const searchParams = await props.searchParams;\n    const session = await getServerSession(authOptions);\n\n    if (!session || !session.user || session.user.role !== \"manager\") {\n        redirect(\"/warehouse\");\n    }\n\n    const data = await getDashboardData(searchParams.date);\n\n    return <DashboardClient data={data} />;\n}\n"],"names":[],"mappings":"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","ignoreList":[0]}